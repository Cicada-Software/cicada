<!DOCTYPE html>
<html>

<head>
<title>Settings</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="/static/common.css">
<script src="/static/auth.js"></script>
</head>

<body>

<main>
  <div class="navbar">
    <a href="/dashboard" id="back">&#8592; Back</a>
    <span id="version">Cicada (pre-alpha)</span>
    <img id="logout" src="/static/img/logout.svg" onclick="logout()" />
  </div>

  <div id="error-msg" style="display: none"></div>

  <h1>Settings</h1>

  <h3>Change Password</h3>

  <form id="change-pwd" onSubmit="handleChangePassword(event)" onInput="handleInput(event)">
    <input
      type="password"
      name="password"
      placeholder="Password"
      autocomplete=off
      minlength="12"
    />
    <button type="submit" disabled>Update</button>
  </form>

  <span id="post-change-password" style="display: none;"></span>
</main>

<style>
* {
  font-family: "jetbrains", monospace;
}

html, body {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}

h1 {
  color: var(--white);
  margin: 0;
  font-size: 1.5em;
  padding-bottom: 1em;
}

h3 {
  color: var(--lightgray);
  margin: 0;
}

a {
  color: var(--blue);
}

form {
  display: flex;
  gap: 1em;
}

input {
  background: var(--gray);
  color: var(--white);
  width: 20em;
  padding: 0.75em;
}

input:disabled {
  opacity: 0.5;
}

button {
  background: var(--green);
  color: var(--gray);
  padding: 0.75em;
}

button:disabled {
  background: var(--dark-green);
  color: var(--black);
}

/* TODO: dedupe */
#back {
  transition: background 150ms;
}

#back:hover {
  background: var(--medium-gray);
}

main {
  display: flex;
  flex-direction: column;
  row-gap: 1em;
  padding: 1em;
  min-height: 100%;
  box-sizing: border-box;
  background: var(--black);
}

.navbar {
  display: flex;
  flex-direction: row;
  gap: 1em;
  margin: 0;
  color: var(--white);
  font-weight: bold;
}

.navbar > * {
  padding: 0.5em;
  background: var(--gray);
}

#version {
  color: var(--lightgray);
  flex: 1;
}

#post-change-password {
  display: none;
  color: var(--lightgray);
  font-style: italic;
}
</style>

<script>
const MIN_PASSWORD_LEN = 12;

const jwtPayload = JSON.parse(atob(localStorage.getItem("jwt").split(".")[1]));

if (jwtPayload["iss"] !== "cicada") {
  const form = document.getElementById("change-pwd");

  for (const element of form.children) {
    element.disabled = true;
    element.title = "SSO users cannot change their passwords";
  }
}

ping();

const handleChangePassword = e => {
  e.preventDefault();

  const box = document.getElementById("post-change-password");
  let msg = "";

  cicadaFetch("/change_password", {method: "POST", body: new FormData(e.target)})
    .then(resp => {
      resp.json().then(j => {
        document.querySelector("input[name=password]").value = "";
        document.querySelector("button[type=submit]").disabled = true;

        box.style.display = "block";

        if (resp.ok) {
          box.innerText = "Password updated";
        } else {
          box.style.color = "var(--red)";
          box.innerText = j.detail;
        }
      });
    })
    .catch(err => console.log({err}));
};

const handleInput = e => {
  const shouldDisable = e.target.value.length < MIN_PASSWORD_LEN;

  document.querySelector("button[type=submit]").disabled = shouldDisable;

  const box = document.getElementById("post-change-password");

  if (shouldDisable) {
    box.style.display = "block";
    box.innerText = `Password must be at least ${MIN_PASSWORD_LEN} characters`;
  } else {
    box.style.display = "none";
  }
};
</script>

</body>

</html>
