/* ansi_up.js
 * author : Dru Nelson
 * license : MIT
 * http://github.com/drudru/ansi_up
 */
"use strict";var PacketKind=(r=>(r[r.EOS=0]="EOS",r[r.Text=1]="Text",r[r.Incomplete=2]="Incomplete",r[r.ESC=3]="ESC",r[r.Unknown=4]="Unknown",r[r.SGR=5]="SGR",r[r.OSCURL=6]="OSCURL",r))(PacketKind||{});class AnsiUp{constructor(){this.VERSION="5.2.1";this.setup_palettes(),this._use_classes=!1,this.bold=!1,this.italic=!1,this.underline=!1,this.fg=this.bg=null,this._buffer="",this._url_whitelist={http:1,https:1},this._escape_html=!0}set use_classes(e){this._use_classes=e}get use_classes(){return this._use_classes}set url_whitelist(e){this._url_whitelist=e}get url_whitelist(){return this._url_whitelist}set escape_html(e){this._escape_html=e}get escape_html(){return this._escape_html}setup_palettes(){this.ansi_colors=[[{rgb:[0,0,0],class_name:"ansi-black"},{rgb:[187,0,0],class_name:"ansi-red"},{rgb:[0,187,0],class_name:"ansi-green"},{rgb:[187,187,0],class_name:"ansi-yellow"},{rgb:[0,0,187],class_name:"ansi-blue"},{rgb:[187,0,187],class_name:"ansi-magenta"},{rgb:[0,187,187],class_name:"ansi-cyan"},{rgb:[255,255,255],class_name:"ansi-white"}],[{rgb:[85,85,85],class_name:"ansi-bright-black"},{rgb:[255,85,85],class_name:"ansi-bright-red"},{rgb:[0,255,0],class_name:"ansi-bright-green"},{rgb:[255,255,85],class_name:"ansi-bright-yellow"},{rgb:[85,85,255],class_name:"ansi-bright-blue"},{rgb:[255,85,255],class_name:"ansi-bright-magenta"},{rgb:[85,255,255],class_name:"ansi-bright-cyan"},{rgb:[255,255,255],class_name:"ansi-bright-white"}]],this.palette_256=[],this.ansi_colors.forEach(s=>{s.forEach(t=>{this.palette_256.push(t)})});let e=[0,95,135,175,215,255];for(let s=0;s<6;++s)for(let t=0;t<6;++t)for(let n=0;n<6;++n){let l={rgb:[e[s],e[t],e[n]],class_name:"truecolor"};this.palette_256.push(l)}let i=8;for(let s=0;s<24;++s,i+=10){let t={rgb:[i,i,i],class_name:"truecolor"};this.palette_256.push(t)}}escape_txt_for_html(e){return this._escape_html?e.replace(/[&<>"']/gm,i=>{if(i==="&")return"&amp;";if(i==="<")return"&lt;";if(i===">")return"&gt;";if(i==='"')return"&quot;";if(i==="'")return"&#x27;"}):e}append_buffer(e){var i=this._buffer+e;this._buffer=i}get_next_packet(){var e={kind:0,text:"",url:""},i=this._buffer.length;if(i==0)return e;var s=this._buffer.indexOf("\x1B");if(s==-1)return e.kind=1,e.text=this._buffer,this._buffer="",e;if(s>0)return e.kind=1,e.text=this._buffer.slice(0,s),this._buffer=this._buffer.slice(s),e;if(s==0){if(i<3)return e.kind=2,e;var t=this._buffer.charAt(1);if(t!="["&&t!="]"&&t!="(")return e.kind=3,e.text=this._buffer.slice(0,1),this._buffer=this._buffer.slice(1),e;if(t=="["){this._csi_regex||(this._csi_regex=rgx`^(?:\x1b\[([\x3c-\x3f]?)([\d;]*)([\x20-\x2f]?[\x40-\x7e]))|(?:\x1b\[[\x20-\x7e]*([\x00-\x1f:]))`);let l=this._buffer.match(this._csi_regex);if(l===null)return e.kind=2,e;if(l[4])return e.kind=3,e.text=this._buffer.slice(0,1),this._buffer=this._buffer.slice(1),e;l[1]!=""||l[3]!="m"?e.kind=4:e.kind=5,e.text=l[2];var n=l[0].length;return this._buffer=this._buffer.slice(n),e}else if(t=="]"){if(i<4)return e.kind=2,e;if(this._buffer.charAt(2)!="8"||this._buffer.charAt(3)!=";")return e.kind=3,e.text=this._buffer.slice(0,1),this._buffer=this._buffer.slice(1),e;this._osc_st||(this._osc_st=rgxG`(?:(\x1b\\)|(\x07))|([\x00-\x06]|[\x08-\x1a]|[\x1c-\x1f])`),this._osc_st.lastIndex=0;{let a=this._osc_st.exec(this._buffer);if(a===null)return e.kind=2,e;if(a[3])return e.kind=3,e.text=this._buffer.slice(0,1),this._buffer=this._buffer.slice(1),e}{let a=this._osc_st.exec(this._buffer);if(a===null)return e.kind=2,e;if(a[3])return e.kind=3,e.text=this._buffer.slice(0,1),this._buffer=this._buffer.slice(1),e}this._osc_regex||(this._osc_regex=rgx`^\x1b\]8;[\x20-\x3a\x3c-\x7e]*;([\x21-\x7e]{0,512})(?:(?:\x1b\\)|(?:\x07))([\x20-\x7e]+)\x1b\]8;;(?:(?:\x1b\\)|(?:\x07))`);let l=this._buffer.match(this._osc_regex);if(l===null)return e.kind=3,e.text=this._buffer.slice(0,1),this._buffer=this._buffer.slice(1),e;e.kind=6,e.url=l[1],e.text=l[2];var n=l[0].length;return this._buffer=this._buffer.slice(n),e}else if(t=="(")return e.kind=4,this._buffer=this._buffer.slice(3),e}}ansi_to_html(e){this.append_buffer(e);for(var i=[];;){var s=this.get_next_packet();if(s.kind==0||s.kind==2)break;s.kind==3||s.kind==4||(s.kind==1?i.push(this.transform_to_html(this.with_state(s))):s.kind==5?this.process_ansi(s):s.kind==6&&i.push(this.process_hyperlink(s)))}return i.join("")}with_state(e){return{bold:this.bold,italic:this.italic,underline:this.underline,fg:this.fg,bg:this.bg,text:e.text}}process_ansi(e){let i=e.text.split(";");for(;i.length>0;){let s=i.shift(),t=parseInt(s,10);if(isNaN(t)||t===0)this.fg=this.bg=null,this.bold=!1,this.italic=!1,this.underline=!1;else if(t===1)this.bold=!0;else if(t===3)this.italic=!0;else if(t===4)this.underline=!0;else if(t===22)this.bold=!1;else if(t===23)this.italic=!1;else if(t===24)this.underline=!1;else if(t===39)this.fg=null;else if(t===49)this.bg=null;else if(t>=30&&t<38)this.fg=this.ansi_colors[0][t-30];else if(t>=40&&t<48)this.bg=this.ansi_colors[0][t-40];else if(t>=90&&t<98)this.fg=this.ansi_colors[1][t-90];else if(t>=100&&t<108)this.bg=this.ansi_colors[1][t-100];else if((t===38||t===48)&&i.length>0){let n=t===38,l=i.shift();if(l==="5"&&i.length>0){let r=parseInt(i.shift(),10);r>=0&&r<=255&&(n?this.fg=this.palette_256[r]:this.bg=this.palette_256[r])}if(l==="2"&&i.length>2){let r=parseInt(i.shift(),10),a=parseInt(i.shift(),10),h=parseInt(i.shift(),10);if(r>=0&&r<=255&&a>=0&&a<=255&&h>=0&&h<=255){let _={rgb:[r,a,h],class_name:"truecolor"};n?this.fg=_:this.bg=_}}}}}transform_to_html(e){let i=e.text;if(i.length===0||(i=this.escape_txt_for_html(i),!e.bold&&!e.italic&&!e.underline&&e.fg===null&&e.bg===null))return i;let s=[],t=[],n=e.fg,l=e.bg;e.bold&&s.push("font-weight:bold"),e.italic&&s.push("font-style:italic"),e.underline&&s.push("text-decoration:underline"),this._use_classes?(n&&(n.class_name!=="truecolor"?t.push(`${n.class_name}-fg`):s.push(`color:rgb(${n.rgb.join(",")})`)),l&&(l.class_name!=="truecolor"?t.push(`${l.class_name}-bg`):s.push(`background-color:rgb(${l.rgb.join(",")})`))):(n&&s.push(`color:rgb(${n.rgb.join(",")})`),l&&s.push(`background-color:rgb(${l.rgb})`));let r="",a="";return t.length&&(r=` class="${t.join(" ")}"`),s.length&&(a=` style="${s.join(";")}"`),`<span${a}${r}>${i}</span>`}process_hyperlink(e){let i=e.url.split(":");return i.length<1||!this._url_whitelist[i[0]]?"":`<a href="${this.escape_txt_for_html(e.url)}">${this.escape_txt_for_html(e.text)}</a>`}}function rgx(f,...e){let i=f.raw[0],s=/^\s+|\s+\n|\s*#[\s\S]*?\n|\n/gm,t=i.replace(s,"");return new RegExp(t)}function rgxG(f,...e){let i=f.raw[0],s=/^\s+|\s+\n|\s*#[\s\S]*?\n|\n/gm,t=i.replace(s,"");return new RegExp(t,"g")}
